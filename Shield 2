-- Auto Shield (scheduled windows, standalone)
-- M·ªói entry trong `schedule` l√† {start_seconds, end_seconds} t√≠nh t·ª´ l√∫c script b·∫Øt ƒë·∫ßu (tick0).
-- Khi c√≥ √≠t nh·∫•t 1 c·ª≠a s·ªï ƒëang active => g·ª≠i shield = true. Khi kh√¥ng c√≤n c·ª≠a s·ªï n√†o => g·ª≠i shield = false.

local schedule = {
    {59, 67},   -- b·∫Øt ƒë·∫ßu 59s, k·∫øt th√∫c 67s
    {83, 91},   -- b·∫Øt ƒë·∫ßu 83s, k·∫øt th√∫c 91s
    {105, 113}, -- b·∫Øt ƒë·∫ßu 105s, k·∫øt th√∫c 113s
}

local AUTO_CLEAR = 140 -- ‚è± th·ªùi gian t·ª± ƒë·ªông x√≥a script
local running = true   -- c·ªù ƒëi·ªÅu khi·ªÉn global

-- üîç t√¨m remote: ReplicatedStorage -> BridgeNet2 -> dataRemoteEvent (fallback: t√¨m descendants)
local remote
pcall(function()
    local rs = game:GetService("ReplicatedStorage")
    local bridge = rs:FindFirstChild("BridgeNet2")
    if bridge then
        remote = bridge:FindFirstChild("dataRemoteEvent")
    end
    if not remote then
        for _, v in ipairs(rs:GetDescendants()) do
            if v.Name == "dataRemoteEvent" then
                remote = v
                break
            end
        end
    end
end)

-- üõ°Ô∏è G·ª≠i t√≠n hi·ªáu Shield an to√†n
local function safeFireShield(state)
    if not running then return end
    if remote then
        pcall(function()
            remote:FireServer({ state, "\024" })
        end)
    else
        if not safeFireShield._warned then
            safeFireShield._warned = true
            warn("[Auto Shield] Kh√¥ng t√¨m th·∫•y dataRemoteEvent; kh√¥ng g·ª≠i ƒë∆∞·ª£c y√™u c·∫ßu.")
        end
    end
end

-- üìä Qu·∫£n l√Ω tr·∫°ng th√°i khi c√≥ nhi·ªÅu c·ª≠a s·ªï (ƒë·∫øm s·ªë c·ª≠a s·ªï active)
local activeCount = 0
local tick0 = tick()

for i, win in ipairs(schedule) do
    local startT, endT = win[1], win[2]
    if type(startT) ~= "number" or type(endT) ~= "number" or endT <= startT then
        warn(("[Auto Shield] Schedule #%d kh√¥ng h·ª£p l·ªá (start=%s end=%s) - b·ªè qua"):format(i, tostring(startT), tostring(endT)))
    else
        task.spawn(function()
            -- ch·ªù ƒë·∫øn th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu
            local waitUntil = tick0 + startT
            local toWait = waitUntil - tick()
            if toWait > 0 then task.wait(toWait) end
            if not running then return end

            -- n·∫øu ƒë√£ qua end time th√¨ b·ªè qua
            if tick() >= tick0 + endT then
                warn(("[Auto Shield] Schedule #%d ƒë√£ tr√¥i qua tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu - b·ªè qua."):format(i))
                return
            end

            -- b·∫Øt ƒë·∫ßu c·ª≠a s·ªï
            activeCount = activeCount + 1
            if activeCount == 1 then
                print(("[Auto Shield] Schedule #%d ON (%.1fs -> %.1fs) -> g·ª≠i SHIELD = true"):format(i, startT, endT))
                safeFireShield(true)
            else
                print(("[Auto Shield] Schedule #%d ON (%.1fs -> %.1fs) -> activeCount=%d"):format(i, startT, endT, activeCount))
            end

            -- ch·ªù t·ªõi end time
            local waitEnd = (tick0 + endT) - tick()
            if waitEnd > 0 then task.wait(waitEnd) end
            if not running then return end

            activeCount = math.max(0, activeCount - 1)
            if activeCount == 0 then
                print(("[Auto Shield] Schedule #%d OFF (k·∫øt th√∫c %.1fs) -> g·ª≠i SHIELD = false"):format(i, endT))
                safeFireShield(false)
            else
                print(("[Auto Shield] Schedule #%d OFF (k·∫øt th√∫c %.1fs) -> c√≤n activeCount=%d"):format(i, endT, activeCount))
            end
        end)
    end
end  

-- ‚ôªÔ∏è T·ª∞ ƒê·ªòNG CLEAR TO√ÄN B·ªò SAU 140 GI√ÇY
task.spawn(function()
    task.wait(AUTO_CLEAR)
    running = false
    print(("[Auto Shield] ƒê√£ h·∫øt %ds ‚Äî script s·∫Ω t·ª± clear."):format(AUTO_CLEAR))
    pcall(function()
        safeFireShield(false)
        script:Destroy()
    end)
end)
